<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lev Miserables - A Drinking Game</title>
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050608;
      color: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .game-container {
      background: #0b0d12;
      border: 1px solid #333;
      border-radius: 16px;
      padding: 20px;
      max-width: 1100px;
      width: 95%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
    }

    .title {
      font-size: 1.6rem;
      margin-bottom: 4px;
      text-align: center;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #f2f2f2;
    }

    .subtitle {
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 14px;
      color: #aaa;
    }

    .status-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.85rem;
      margin-bottom: 10px;
      color: #c9c9c9;
    }

    .status-bar > div {
      flex: 1 1 45%;
    }

    .layout {
      display: flex;
      gap: 16px;
    }

    .main-panel {
      flex: 2;
      min-width: 0;
    }

    .log-panel {
      flex: 1;
      min-width: 220px;
      display: flex;
      flex-direction: column;
    }

    .ascii-art {
      background: #050608;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 14px;
      white-space: pre;
      font-family: "Fira Code", "Cascadia Mono", Consolas, monospace;
      font-size: 13px;
      overflow-x: auto;
    }

    .description {
      margin-bottom: 12px;
      line-height: 1.5;
      font-size: 0.98rem;
    }

    .choices {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    .choices button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #444;
      background: #151824;
      color: #f5f5f5;
      font-size: 0.95rem;
      text-align: left;
      cursor: pointer;
      transition:
        transform 0.07s ease,
        box-shadow 0.07s ease,
        background 0.2s ease,
        border-color 0.2s ease;
    }

    .choices button:hover {
      background: #22263a;
      border-color: #666;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.08);
      transform: translateY(-1px);
    }

    .choices button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .log {
      border-left: 1px solid #222;
      padding-left: 10px;
      margin-left: 4px;
      font-size: 0.85rem;
      flex: 1;
      overflow-y: auto;
      color: #bfbfbf;
    }

    .log-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: #ddd;
    }

    .log-entry {
      margin-bottom: 2px;
    }

    .hint {
      margin-top: 6px;
      font-size: 0.78rem;
      color: #888;
      text-align: right;
    }

    @media (max-width: 800px) {
      .layout {
        flex-direction: column;
      }
      .log {
        max-height: 200px;
      }
    }

    @media (max-width: 600px) {
      .ascii-art { font-size: 11px; }
      .status-bar > div { flex: 1 1 100%; }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="title">LEV MISERABLES</div>
    <div class="subtitle">A Drinking Game on Stockport Road</div>

    <div class="status-bar">
      <div><strong>Location:</strong> <span id="statusLocation"></span></div>
      <div><strong>Cash:</strong> <span id="statusCash"></span></div>
      <div><strong>Card:</strong> <span id="statusCard"></span></div>
      <div><strong>Drunk:</strong> <span id="statusDrunk"></span></div>
      <div><strong>Satiation:</strong> <span id="statusSatiation"></span></div>
    </div>

    <div class="layout">
      <div class="main-panel">
        <pre id="asciiArt" class="ascii-art"></pre>
        <div id="description" class="description"></div>
        <div id="choices" class="choices"></div>
      </div>

      <div class="log-panel">
        <div class="log-title">Action Log</div>
        <div id="log" class="log"></div>
        <div class="hint">Press 1‚Äì9 to choose an option.</div>
      </div>
    </div>
  </div>

  <script>
    // --- GAME STATE ---
    const gameState = {
      location: "Stockport Road",
      hasCash: false,
      hasCard: true,
      cardInMachine: false,
      cardLost: false,
      pendingCash: false,
      drunk: 0,
      satiation: 0,
      eatenSamoon: false,
      wifeWantsQuorn: false,
      log: []
    };

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Simple scorer pools
    const unitedScorers = [
      "Bruno Fernandes",
      "Mason Mount",
      "Matheus Cunha",
      "Joshua Zirkzee",
      "Benjamin ≈†e≈°ko",
      "Bryan Mbeumo",
      "Kobbie Mainoo"
    ];

    const evertonScorers = [
      "Dominic Calvert-Lewin",
      "Beto",
      "Jack Grealish",
      "Dwight McNeil",
      "Iliman Ndiaye",
      "Thierno Barry"
    ];

    const villaScorers = [
      "Ollie Watkins",
      "Leon Bailey",
      "Moussa Diaby",
      "John McGinn"
    ];

    function pickRandom(array) {
      return array[randInt(0, array.length - 1)];
    }

    function randomScorer(teamName) {
      if (teamName === "Manchester United") return pickRandom(unitedScorers);
      if (teamName === "Everton") return pickRandom(evertonScorers);
      if (teamName === "Aston Villa") return pickRandom(villaScorers);
      return "a player from " + teamName;
    }

    // Queue log lines with a delay between each
    function queueLogEvents(lines, delayMs, onComplete) {
      let i = 0;
      function next() {
        if (i >= lines.length) {
          if (onComplete) onComplete();
          return;
        }
        addLog(lines[i]);
        render();
        i++;
        setTimeout(next, delayMs);
      }
      next();
    }

    // --- WORLD / LOCATIONS ---
    const locations = {
      "Stockport Road": {
        ascii: String.raw`

   It's late on Stockport Road. Headlights smear through drizzle; shopfronts glow
   in neon and sodium. You can see:

          [ ISCA ]       [ UNION PUB ]       [ LEVY BAKERY ]
          [ NISPY ]      [ TESCO ]           [ ATM ]

   Somewhere between glory and shame, you must choose your route.
        `,
        description: "You stand on Stockport Road, poised between greatness and questionable decisions. Where to first?",
        actions: [
          { label: "Go to The Union (Pub)", type: "move", target: "The Union" },
          { label: "Go to Nispy (Fried chicken shop)", type: "move", target: "Nispy" },
          { label: "Go to Isca (Wine bar)", type: "move", target: "Isca" },
          { label: "Go to Levy Bakery (Kebabs)", type: "move", target: "Levy Bakery" },
          { label: "Go to Tesco (Supermarket)", type: "move", target: "Tesco" },
          { label: "Go to ATM (Cash machine)", type: "move", target: "ATM" },
          { label: "Go home and end the night", type: "action", id: "end_night" }
        ]
      },

      "The Union": {
        ascii: String.raw`
           ______________________________________
          |   THE UNION                         |
          |-------------------------------------|
          |  ‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà   TV: ‚öΩ       |
          |  ‚ñà   ‚ñà  ‚ñà   ‚ñà  ‚ñà   ‚ñà                |
          |  ‚ñà   ‚ñà  ‚ñà   ‚ñà  ‚ñà   ‚ñà   ‚ô™ KARAOKE ‚ô™ |
          |                                     |
          |   [ BAR ]          [ STICKY FLOOR ] |
          |_____________________________________|

   The pub is loud but comforting. Condensation on windows, pints on every table,
   and Rockin Ronnie guarding the karaoke queue like a dragon.
        `,
        description: "Sticky carpet, familiar faces, and the comforting whiff of spilt Guinness. Rockin Ronnie is queueing up karaoke.",
        actions: [
          { label: "Order a pint of Guinness", type: "action", id: "union_guinness" },
          { label: "Sing a song on karaoke", type: "action", id: "union_karaoke" },
          { label: "Dance with Julie", type: "action", id: "union_dance_julie" },
          { label: "Leave back to Stockport Road", type: "move", target: "Stockport Road" }
        ]
      },

      "Nispy": {
        ascii: String.raw`
                _____________________________
               |   N I S P Y   C H I C K E N |
               |-----------------------------|
               |  [ HOT LAMP ]   [ MENU ]    |
               |   üçó üçó üçó    1. Meal Deal |
               |   üçó üçó üçó    2. Wings     |
               |                             |
               |  COUNTER  | 'SALT?'   üßÇ   |
               |___________|_________________|

   Heat lamps glow amber over trays of fried chicken. The air is thick with oil,
   spice, and half-shouted orders.
        `,
        description: "The warm glow of the heat lamps. The smell of fried everything. A man in front of you is arguing about sauce.",
        actions: [
          { label: "Order a meal", type: "action", id: "nispy_meal" },
          { label: "Ask for extra salt", type: "action", id: "nispy_salt" },
          { label: "Leave back to Stockport Road", type: "move", target: "Stockport Road" }
        ]
      },

      "Isca": {
        ascii: String.raw`
             ___________________________
            |          ISCA            |
            |--------------------------|
            |   üç∑   üç∑   üç∑          |
            |  [BAR]  glasses softly   |
            |         clinking         |
            |                          |
            |  small tables, candles   |
            |  and low murmured chat   |
            |__________________________|

   Natural wine bottles line the wall, each with a label more abstract than last.
   Someone at the bar is saying 'skin contact' a suspicious amount.
        `,
        description: "Soft lighting, clinking glasses, and someone saying the word 'minerality' unironically.",
        actions: [
          { label: "Order a glass of fizz", type: "action", id: "isca_fizz" },
          { label: "Order a glass of red", type: "action", id: "isca_red" },
          { label: "Order a glass of white", type: "action", id: "isca_white" },
          { label: "Order a cheese board", type: "action", id: "isca_cheese" },
          { label: "Leave back to Stockport Road", type: "move", target: "Stockport Road" }
        ]
      },

      "Levy Bakery": {
        ascii: String.raw`
            _________________________________
           |        LEVY BAKERY (SAMOON)     |
           |---------------------------------|
           |  OVEN: üî•üî•üî•      GRILL: ‚ñì‚ñì‚ñì  |
           |                                 |
           |   trays of oval Samoon bread    |
           |   stacked behind a glass case   |
           |                                 |
           |  [ COUNTER ]   'Cash only, luv' |
           |_________________________________|

   The warmth hits you as you step in: fresh bread, grilling meat, sesame and spice.
   This is where nights are anchored and redeemed.
        `,
        description: "The counter is lined with glorious Samoon bread. The grill sizzles. This is the point of no return.",
        actions: [
          { label: "Order a mixed Samoon", type: "action", id: "levy_mixed" },
          { label: "Order a Falafel Samoon", type: "action", id: "levy_falafel" },
          { label: "Leave back to Stockport Road", type: "move", target: "Stockport Road" }
        ]
      },

      "Tesco": {
        ascii: String.raw`
               ___________________________
              |          TESCO            |
              |---------------------------|
              |  AISLE 1  |  AISLE 2      |
              |  snacks   |  frozen veg   |
              |  ----->   |  nuggies ‚û§    |
              |                           |
              |  self-checkouts: 'Beep'   |
              |___________________________|

   Fluorescent lighting hums overhead. Baskets clatter, scanners beep, and
   everyone is pretending not to read the meal deal options for the fourth time.
        `,
        description: "Fluorescent lighting, aisles of mild chaos, and a queue of people buying exactly three items.",
        actions: [
          { label: "Buy kitchen roll", type: "action", id: "tesco_kitchen_roll" },
          { label: "Buy Quorn chicken nuggies", type: "action", id: "tesco_quorn" },
          { label: "Leave back to Stockport Road", type: "move", target: "Stockport Road" }
        ]
      },

      "ATM": {
        ascii: String.raw`
           street corner, slightly damp
           ______________________
          |  [    BANK ATM    ] |
          |  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  |
          |  |  ENTER PIN   |  |
          |  |              |  |
          |  |   [¬£¬£¬£¬£]     |  |
          |  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  |
          |   card slot  ‚¨õ     |
          |____________________|

   The ATM glows against the dark, a shrine to reckless financial decisions.
        `,
        description: "A lonely ATM hums softly, ready to enable more questionable purchases.",
        actions: [
          { label: "Insert card", type: "action", id: "atm_insert_card" },
          { label: "Withdraw money", type: "action", id: "atm_withdraw" },
          { label: "Take cash", type: "action", id: "atm_take_cash" },
          { label: "Retrieve card", type: "action", id: "atm_retrieve_card" },
          { label: "Leave back to Stockport Road", type: "move", target: "Stockport Road" }
        ]
      },

      "Home": {
        ascii: String.raw`
                 your flat, some time later

                 ________________________
                |  __________   ____     |
                | |  SOFA   | | TV |     |
                | |_________| |____|     |
                |                       |
                |   coat on chair       |
                |   keys by the door    |
                |_______________________|

   You finally make it home. Stockport Road is a rumour outside the window now,
   and the night settles into memory.
        `,
        description: "You finally make it home. The night in Levenshulme fades into a fuzzy memory.",
        actions: [
          { label: "Restart Lev Miserables", type: "action", id: "restart_game" }
        ]
      }
    };

    // --- MATCH SIMULATION WITH TIMELINE ---
    function simulateMatch() {
      const derbies = [
        {
          home: "Manchester United",
          away: "Everton",
          name: "The Sherbets Derby"
        },
        {
          home: "Manchester United",
          away: "Aston Villa",
          name: "The Scrumpuss Derby"
        }
      ];

      const derby = derbies[randInt(0, derbies.length - 1)];

      // First half goals
      const fhHome = randInt(0, 3);
      const fhAway = randInt(0, 3);
      const firstHalfGoals = [];
      for (let i = 0; i < fhHome; i++) firstHalfGoals.push({ team: "home" });
      for (let i = 0; i < fhAway; i++) firstHalfGoals.push({ team: "away" });
      firstHalfGoals.sort(() => Math.random() - 0.5);

      // Second half goals
      const shHomeGoals = randInt(0, 3);
      const shAwayGoals = randInt(0, 3);
      const secondHalfGoals = [];
      for (let i = 0; i < shHomeGoals; i++) secondHalfGoals.push({ team: "home" });
      for (let i = 0; i < shAwayGoals; i++) secondHalfGoals.push({ team: "away" });
      secondHalfGoals.sort(() => Math.random() - 0.5);

      let homeTotal = fhHome + shHomeGoals;
      let awayTotal = fhAway + shAwayGoals;
      let wentToET = false;
      let etGoals = [];
      let winner = null;

      const lines = [];

      lines.push(`Potts and The Devil summon you to The Union to watch ${derby.home} vs ${derby.away} (${derby.name}).`);

      // First-half goals
      firstHalfGoals.forEach((g) => {
        const teamName = g.team === "home" ? derby.home : derby.away;
        const scorer = randomScorer(teamName);
        lines.push(`First half: GOAL for ${teamName}! ${scorer} scores.`);
      });

      lines.push(`Half time: ${derby.home} ${fhHome}‚Äì${fhAway} ${derby.away}.`);

      // Second half goals
      secondHalfGoals.forEach((g) => {
        const teamName = g.team === "home" ? derby.home : derby.away;
        const scorer = randomScorer(teamName);
        lines.push(`Second half: GOAL for ${teamName}! ${scorer} finds the net.`);
      });

      if (homeTotal === awayTotal) {
        // Chance to go to extra time if level after 90 minutes
        if (Math.random() < 0.6) {
          wentToET = true;
          const etHome = randInt(0, 2);
          const etAway = randInt(0, 2);
          const beforeETHome = homeTotal;
          const beforeETAway = awayTotal;

          for (let i = 0; i < etHome; i++) etGoals.push({ team: "home" });
          for (let i = 0; i < etAway; i++) etGoals.push({ team: "away" });
          etGoals.sort(() => Math.random() - 0.5);

          homeTotal += etHome;
          awayTotal += etAway;

          lines.push(`After 90 minutes it's still level at ${derby.home} ${beforeETHome}‚Äì${beforeETAway} ${derby.away}. It goes to extra time.`);

          etGoals.forEach((g) => {
            const teamName = g.team === "home" ? derby.home : derby.away;
            const scorer = randomScorer(teamName);
            lines.push(`Extra time: GOAL for ${teamName}! ${scorer} might have won it.`);
          });

          lines.push(`After extra time: ${derby.home} ${homeTotal}‚Äì${awayTotal} ${derby.away}.`);
        }
      }

      let wentToPens = false;
      let homePens = 0;
      let awayPens = 0;

      // Penalties if still level
      if (homeTotal === awayTotal) {
        wentToPens = true;
        homePens = randInt(4, 7);
        awayPens = randInt(4, 7);
        if (awayPens === homePens) {
          awayPens += (Math.random() < 0.5 ? 1 : -1);
          if (awayPens < 0) awayPens = 0;
        }

        const homeWins = homePens > awayPens;
        if (!wentToET) {
          lines.push(`After 90 minutes it's still level at ${derby.home} ${homeTotal}‚Äì${awayTotal} ${derby.away}. It goes straight to penalties.`);
        } else {
          lines.push("It's still level after extra time. It goes to penalties.");
        }

        lines.push("Penalty shootout: the bar falls silent as each kick is taken...");

        if (homeWins) {
          lines.push(`${derby.home} win ${homePens}‚Äì${awayPens} on penalties.`);
          winner = derby.home;
        } else {
          lines.push(`${derby.away} win ${awayPens}‚Äì${homePens} on penalties.`);
          winner = derby.away;
        }
      } else {
        if (wentToET) {
          lines.push(`Full time after extra time: ${derby.home} ${homeTotal}‚Äì${awayTotal} ${derby.away}.`);
        } else {
          lines.push(`Full time: ${derby.home} ${homeTotal}‚Äì${awayTotal} ${derby.away}.`);
        }
        winner = homeTotal > awayTotal ? derby.home : derby.away;
      }

      // Reactions
      if (winner === "Everton") {
        lines.push("Everton win! Potts is elated and announces he's off home to roast a chicken.");
      } else if (winner === "Manchester United") {
        lines.push("Manchester United win! The Devil is in his element and buys you a Guinness.");
      } else if (winner === "Aston Villa") {
        lines.push("Aston Villa win! Your wife turns up at The Union and buys you a Guinness.");
      }

      // Play the timeline, then apply drunk consequences
      queueLogEvents(lines, 2000, () => {
        if (winner === "Manchester United" || winner === "Aston Villa") {
          gameState.drunk = clamp(gameState.drunk + 2, 0, 10);
          checkForBlackout();
          render();
        }
      });
    }

    // --- RANDOM EVENTS ---
    function maybeRandomEvent() {
      if (gameState.location === "Home") return;
      const roll = Math.random();
      const current = gameState.location;

      if (roll < 0.05 && current !== "The Union") {
        addLog("You bump into The Devil, who grins and steers you firmly towards The Union.");
        gameState.location = "The Union";
        render();
      } else if (roll < 0.10 && current !== "Levy Bakery") {
        addLog("You run into Potts, who insists you accompany him directly to Levy Bakery.");
        gameState.location = "Levy Bakery";
        render();
      } else if (roll < 0.15) {
        addLog("Your phone buzzes: your wife messages asking you to buy Quorn chicken nuggies.");
      } else if (roll < 0.20 && current !== "The Union") {
        gameState.location = "The Union";
        render();
        simulateMatch();
        return;
      }
    }

    // --- BLACKOUT LOGIC ---
    function checkForBlackout() {
      if (gameState.drunk >= 10 && gameState.location !== "Home") {
        blackoutToBed();
      }
    }

    function blackoutToBed() {
      gameState.drunk = 10;
      gameState.location = "Home";
      addLog("You reach peak drunkenness and the night dissolves. You black out and wake up in bed.");
      addLog("You have only fragments of the evening, but at least you made it home.");
    }

    // --- ACTION HANDLERS ---
    function performAction(actionId) {
      switch (actionId) {
        // UNION
        case "union_guinness":
          addLog("You order a pint of Guinness. It's oddly emotional.");
          gameState.drunk = clamp(gameState.drunk + 2, 0, 10);
          break;
        case "union_karaoke": {
          if (gameState.drunk < 3) {
            addLog("Rockin Ronnie looks you up and down and says you're far too sober to touch the mic. Come back after a few more drinks.");
          } else if (gameState.drunk > 7) {
            addLog("Rockin Ronnie sighs, 'You're far too drunk for this,' but puts your song on anyway. You absolutely annihilate it in a way no one will forget.");
            gameState.drunk = clamp(gameState.drunk + 1, 0, 10);
          } else {
            addLog("Rockin Ronnie reluctantly puts your song on and you absolutely butcher it.");
            gameState.drunk = clamp(gameState.drunk + 1, 0, 10);
          }
          break;
        }
        case "union_dance_julie":
          addLog("You dance with Julie. It's chaotic but unforgettable.");
          gameState.drunk = clamp(gameState.drunk + 1, 0, 10);
          break;

        // NISPY
        case "nispy_meal":
          if (!gameState.hasCash) {
            addLog("You try to order a meal but realise you have no cash. Nispy is not impressed. Hit the ATM first.");
          } else {
            addLog("You order a gloriously beige meal. Future you will have opinions.");
            gameState.satiation = clamp(gameState.satiation + 2, 0, 10);
            gameState.drunk = clamp(gameState.drunk - 3, 0, 10);
            gameState.hasCash = false;
          }
          break;
        case "nispy_salt":
          addLog("The staff glare and say, 'The food is salty enough already, NO WAY!'");
          break;

        // ISCA
        case "isca_fizz":
          addLog("You sip a glass of fizz and briefly consider moving to Paris.");
          gameState.drunk = clamp(gameState.drunk + 1, 0, 10);
          break;
        case "isca_red":
          addLog("You savour a glass of red and nod like you understand tannins.");
          gameState.drunk = clamp(gameState.drunk + 1, 0, 10);
          break;
        case "isca_white":
          addLog("You enjoy a crisp white that 'really opens up on the second sip'. Allegedly.");
          gameState.drunk = clamp(gameState.drunk + 1, 0, 10);
          break;
        case "isca_cheese":
          addLog("You order a cheese board. It briefly silences the table.");
          gameState.satiation = clamp(gameState.satiation + 1, 0, 10);
          break;

        // LEVY BAKERY
        case "levy_mixed":
          if (!gameState.hasCash) {
            addLog("You reach for your wallet... empty. The staff kindly suggest you visit the ATM first.");
          } else {
            addLog("You buy a mixed Samoon. This is the crescendo of the night.");
            gameState.eatenSamoon = true;
            gameState.satiation = clamp(gameState.satiation + 3, 0, 10);
            gameState.drunk = clamp(gameState.drunk - 3, 0, 10);
            gameState.hasCash = false;
          }
          break;
        case "levy_falafel":
          if (!gameState.hasCash) {
            addLog("You try to order a Falafel Samoon but realise you have no cash. Levy Bakery waits, but your wallet does not.");
          } else {
            addLog("You buy a Falafel Samoon. Glorious, messy, perfect.");
            gameState.eatenSamoon = true;
            gameState.satiation = clamp(gameState.satiation + 3, 0, 10);
            gameState.drunk = clamp(gameState.drunk - 3, 0, 10);
            gameState.hasCash = false;
          }
          break;

        // TESCO
        case "tesco_kitchen_roll":
          addLog("You buy kitchen roll. Responsible, if not glamorous.");
          break;
        case "tesco_quorn":
          if (gameState.wifeWantsQuorn) {
            addLog("You dutifully buy Quorn chicken nuggies. Your wife will be pleased (or at least less annoyed).");
            gameState.wifeWantsQuorn = false;
          } else {
            addLog("You grab a bag of Quorn chicken nuggies. Future you will thank you (or not).");
          }
          gameState.satiation = clamp(gameState.satiation + 1, 0, 10);
          break;

        // ATM
        case "atm_insert_card":
          if (!gameState.hasCard && !gameState.cardInMachine) {
            addLog("You pat your pockets. No card. Perhaps the ATM already claimed it earlier.");
          } else if (gameState.cardInMachine) {
            addLog("Your card is already in the machine.");
          } else {
            gameState.hasCard = false;
            gameState.cardInMachine = true;
            addLog("You insert your card into the ATM.");
          }
          break;
        case "atm_withdraw":
          if (!gameState.cardInMachine) {
            addLog("The ATM beeps impatiently. It would like a card first.");
          } else {
            gameState.pendingCash = true;
            addLog("You request some cash. The machine whirs loudly.");
          }
          break;
        case "atm_take_cash":
          if (!gameState.pendingCash) {
            addLog("There is no cash waiting for you. You stare at the slot hopefully anyway.");
          } else {
            gameState.pendingCash = false;
            gameState.hasCash = true;
            addLog("You take the cash. You are now Samoon-enabled.");
          }
          break;
        case "atm_retrieve_card":
          if (!gameState.cardInMachine) {
            addLog("There is no card to retrieve. Maybe it‚Äôs already in your pocket. Maybe it never was.");
          } else {
            gameState.cardInMachine = false;
            gameState.hasCard = true;
            addLog("You retrieve your card and tuck it safely away.");
          }
          break;

        // END OF NIGHT
        case "end_night":
          endNight();
          render();
          return;

        // RESTART
        case "restart_game":
          window.location.reload();
          return;

        default:
          addLog("You do something indescribable. (Action not implemented.)");
      }

      checkForBlackout();
      if (gameState.location !== "Home") {
        maybeRandomEvent();
      }
      render();
    }

    function endNight() {
      gameState.location = "Home";

      addLog("=== END OF NIGHT ===");

      const hasSamoon = gameState.eatenSamoon;
      const hasCardNow = gameState.hasCard && !gameState.cardLost;

      let reasons = [];
      if (!hasSamoon) reasons.push("you never got your Samoon");
      if (!hasCardNow) reasons.push("you lost track of your card");

      if (hasSamoon && hasCardNow) {
        addLog("WIN: You ate Samoon and made it home with your card. A small but powerful victory.");
      } else {
        const joined = reasons.join(" and ");
        addLog("LOSE: Tonight, " + joined + ". Levenshulme will give you another chance, though.");
      }

      addLog(
        "Final stats ‚Äî Drunk: " + gameState.drunk +
        " / Satiation: " + gameState.satiation +
        " / Cash: " + (gameState.hasCash ? "Yes" : "No") +
        " / Card: " + (hasCardNow ? "Safely with you" : "Not with you")
      );

      if (gameState.drunk >= 8) {
        addLog("You are very much at the ‚Äòsinging to the kebab‚Äô stage of the evening.");
      } else if (gameState.drunk <= 2) {
        addLog("A surprisingly sensible night. Are you feeling okay?");
      }

      if (gameState.satiation >= 8) {
        addLog("You are absolutely stuffed. Samoon plus snacks was perhaps ambitious.");
      } else if (gameState.satiation <= 2) {
        addLog("You probably should have eaten more than that.");
      }
    }

    // --- RENDERING ---
    function render() {
      const loc = locations[gameState.location];

      const asciiEl = document.getElementById("asciiArt");
      const descEl = document.getElementById("description");
      const choicesEl = document.getElementById("choices");
      const statusLocationEl = document.getElementById("statusLocation");
      const statusCashEl = document.getElementById("statusCash");
      const statusCardEl = document.getElementById("statusCard");
      const statusDrunkEl = document.getElementById("statusDrunk");
      const statusSatiationEl = document.getElementById("statusSatiation");
      const logEl = document.getElementById("log");

      statusLocationEl.textContent = gameState.location;
      statusCashEl.textContent = gameState.hasCash ? "Yes" : "No";

      if (gameState.hasCard) {
        statusCardEl.textContent = "In your pocket";
      } else if (gameState.cardInMachine) {
        statusCardEl.textContent = "In the ATM";
      } else {
        statusCardEl.textContent = "Lost somewhere";
      }

      statusDrunkEl.textContent = gameState.drunk + " / 10";
      statusSatiationEl.textContent = gameState.satiation + " / 10";

      asciiEl.textContent = loc.ascii;
      descEl.textContent = loc.description;

      choicesEl.innerHTML = "";
      loc.actions.forEach((action, index) => {
        const btn = document.createElement("button");
        btn.textContent = (index + 1) + ". " + action.label;
        btn.addEventListener("click", () => handleChoice(index));
        choicesEl.appendChild(btn);
      });

      // Show full history, latest at the top
      logEl.innerHTML = "";
      const allEntries = [...gameState.log].reverse();
      allEntries.forEach(entry => {
        const div = document.createElement("div");
        div.className = "log-entry";
        div.textContent = "‚Ä¢ " + entry;
        logEl.appendChild(div);
      });
      logEl.scrollTop = 0;
    }

    function handleChoice(index) {
      const currentLocationName = gameState.location;
      const loc = locations[currentLocationName];
      const action = loc.actions[index];
      if (!action) return;

      if (action.type === "move") {
        if (currentLocationName === "ATM" && gameState.cardInMachine) {
          addLog("You wander off, leaving your card in the ATM. Oops.");
          gameState.cardInMachine = false;
          gameState.hasCard = false;
          gameState.cardLost = true;
        }

        gameState.location = action.target;
        addLog("You head to " + action.target + ".");
        checkForBlackout();
        if (gameState.location !== "Home") {
          maybeRandomEvent();
        }
        render();
      } else if (action.type === "action") {
        performAction(action.id);
      }
    }

    function addLog(text) {
      gameState.log.push(text);
    }

    // Keyboard shortcuts 1‚Äì9
    document.addEventListener("keydown", (event) => {
      if (!/^[1-9]$/.test(event.key)) return;
      const choiceIndex = parseInt(event.key, 10) - 1;
      handleChoice(choiceIndex);
    });

    // Start game
    window.addEventListener("load", () => {
      addLog("You step out onto Stockport Road. The night begins.");
      render();
    });
  </script>
</body>
</html>
