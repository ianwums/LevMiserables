<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lev Miserables - A Drinking Game</title>
  <style>
    * { box-sizing: border-box; }

    :root {
      --bg: #050608;
      --text: #f5f5f5;
      --card-bg: #0b0d12;
      --border: #333;
      --accent-soft: #151824;
      --accent-soft-hover: #22263a;
      --muted: #aaa;
      --muted-strong: #c9c9c9;
      --log-border: #222;
    }

    body.light {
      --bg: #f4f4f4;
      --text: #111;
      --card-bg: #ffffff;
      --border: #ccc;
      --accent-soft: #e9ecf8;
      --accent-soft-hover: #dde2f8;
      --muted: #666;
      --muted-strong: #333;
      --log-border: #ccc;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .game-container {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      max-width: 1100px;
      width: 95%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
      transition: background 0.2s ease, border-color 0.2s ease;
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .title {
      font-size: 1.6rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text);
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 10px;
    }

    #themeToggle {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--accent-soft);
      color: var(--text);
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s ease, border-color 0.2s ease, transform 0.07s ease;
    }

    #themeToggle:hover {
      background: var(--accent-soft-hover);
      border-color: var(--muted);
      transform: translateY(-1px);
    }

    #themeToggle:active {
      transform: translateY(0);
    }

    .status-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.85rem;
      margin-bottom: 10px;
      color: var(--muted-strong);
    }

    .status-bar > div {
      flex: 1 1 45%;
    }

    .layout {
      display: flex;
      gap: 16px;
    }

    .main-panel {
      flex: 2;
      min-width: 0;
    }

    .log-panel {
      flex: 1;
      min-width: 220px;
      display: flex;
      flex-direction: column;
    }

    .game-over-banner {
      display: none;
      text-align: center;
      font-size: 1.6rem;
      font-weight: 900;
      letter-spacing: 0.08em;
      margin-bottom: 8px;
    }

    .ascii-art {
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 14px;
      white-space: pre;
      font-family: "Fira Code", "Cascadia Mono", Consolas, monospace;
      font-size: 13px;
      overflow-x: auto;
    }

    .screens-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .karaoke-screen {
      display: none;
      width: 100%;
      max-width: 260px;
      aspect-ratio: 1 / 1;
      background: #ffeb3b;      /* yellow */
      color: #0d47a1;           /* blue */
      border-radius: 8px;
      border: 2px solid var(--border);
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 1.1rem;
      font-weight: 700;
      padding: 10px;
    }

    .football-screen {
      display: none;
      width: 100%;
      max-width: 260px;
      aspect-ratio: 1 / 1;
      background: #1b5e20;      /* green */
      color: #ffffff;           /* white */
      border-radius: 8px;
      border: 2px solid var(--border);
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 0.9rem;
      font-weight: 700;
      padding: 10px;
      position: relative;
    }

    .football-screen .live-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      background: #d50000;
      color: #ffffff;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 700;
    }

    .football-screen .football-text {
      margin-top: 8px;
    }

    .description {
      margin-bottom: 12px;
      line-height: 1.5;
      font-size: 0.98rem;
    }

    .choices {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    .choices button,
    .karaoke-choices button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--accent-soft);
      color: var(--text);
      font-size: 0.95rem;
      text-align: left;
      cursor: pointer;
      transition:
        transform 0.07s ease,
        box-shadow 0.07s ease,
        background 0.2s ease,
        border-color 0.2s ease;
    }

    .choices button:hover,
    .karaoke-choices button:hover {
      background: var(--accent-soft-hover);
      border-color: var(--muted);
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    .choices button:active,
    .karaoke-choices button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .karaoke-choices {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      border: 1px dashed var(--border);
      background: rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      gap: 6px;
      font-size: 0.85rem;
    }

    body.light .karaoke-choices {
      background: rgba(255,255,255,0.6);
    }

    .karaoke-choices-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .log {
      border-left: 1px solid var(--log-border);
      padding-left: 10px;
      margin-left: 4px;
      font-size: 0.85rem;
      flex: 1;
      overflow-y: auto;
      color: var(--muted-strong);
    }

    .log-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--muted-strong);
    }

    .log-entry {
      margin-bottom: 2px;
    }

    .hint {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--muted);
      text-align: right;
    }

    .summary {
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid var(--log-border);
      font-size: 0.8rem;
      color: var(--muted-strong);
    }

    .summary-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .summary-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .summary-list li {
      margin-bottom: 2px;
    }

    /* Taccy Vom Vom overlay */
    .censored-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .censored-overlay-text {
      font-size: 3rem;
      font-weight: 900;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: #ff5252;
      border: 4px solid #ff5252;
      padding: 20px 40px;
    }

    @media (max-width: 800px) {
      .layout {
        flex-direction: column;
      }
      .log {
        max-height: 200px;
      }
      .censored-overlay-text {
        font-size: 2rem;
        letter-spacing: 0.15em;
      }
    }

    @media (max-width: 600px) {
      .ascii-art { font-size: 11px; }
      .status-bar > div { flex: 1 1 100%; }
      .censored-overlay-text {
        font-size: 1.6rem;
        letter-spacing: 0.12em;
      }
    }
  </style>
</head>
<body class="light">
  <div class="game-container">
    <div class="header-row">
      <div>
        <div class="title">LEV MISERABLES</div>
        <div class="subtitle">A Drinking Game</div>
      </div>
      <button id="themeToggle">Switch to Dark Mode</button>
    </div>

    <div class="status-bar">
      <div><strong>Location:</strong> <span id="statusLocation"></span></div>
      <div><strong>Cash:</strong> <span id="statusCash"></span></div>
      <div><strong>Bank Card:</strong> <span id="statusCard"></span></div>
      <div><strong>Drunk:</strong> <span id="statusDrunk"></span></div>
      <div><strong>Satiation:</strong> <span id="statusSatiation"></span></div>
    </div>

    <div class="layout">
      <div class="main-panel">
        <div id="gameOverBanner" class="game-over-banner">GAME OVER</div>
        <pre id="asciiArt" class="ascii-art"></pre>

        <div class="screens-row">
          <div id="karaokeScreen" class="karaoke-screen"></div>
          <div id="footballScreen" class="football-screen"></div>
        </div>

        <div id="description" class="description"></div>
        <!-- Karaoke choices ABOVE normal choices -->
        <div id="karaokeChoices" class="karaoke-choices"></div>
        <div id="choices" class="choices"></div>
      </div>

      <div class="log-panel">
        <div class="log-title">Action Log</div>
        <div id="log" class="log"></div>
        <div class="hint">Press 1â€“9 to choose an option.</div>

        <div class="summary">
          <div class="summary-title">Session Summary</div>
          <ul class="summary-list" id="sessionSummary"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Taccy Vom Vom overlay -->
  <div id="censoredOverlay" class="censored-overlay">
    <div class="censored-overlay-text">CENSORED</div>
  </div>

  <script>
    // --- GAME STATE ---
    const gameState = {
      location: "Stockport Road",
      hasCash: false,
      hasCard: true,
      cardInMachine: false,
      cardLost: false,
      pendingCash: false,
      drunk: 0,
      satiation: 0,
      eatenSamoon: false,
      wifeWantsQuorn: false,
      log: [],
      drinksCount: 0,
      foodCount: 0,
      matchesWatched: 0,
      karaokeChoosingSong: false,
      songsPerformed: 0
    };

    const karaokeSongs = [
      "THE SMITHS - GIRLFRIEND IN A COMA",
      "ROBBIE WILLIAMS - ROCK DJ",
      "BRUCE SPRINGSTEEN - BORN TO RUN",
      "NANCY SINATRA - BOOTS",
      "BILLY JOEL - WE DIDN'T START THE FIRE",
      "LORDE - GREEN LIGHT",
      "RONAN KEATING - ROLLERCOASTER",
      "DAVID BOWIE - BLACKSTAR",
      "QUEEN (FEAT DAVID BOWIE) - UNDER PRESSURE"
    ];

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function pickRandom(array) {
      return array[randInt(0, array.length - 1)];
    }

    const unitedScorers = [
      "Bruno Fernandes",
      "Mason Mount",
      "Matheus Cunha",
      "Joshua Zirkzee",
      "Benjamin Å eÅ¡ko",
      "Bryan Mbeumo",
      "Kobbie Mainoo"
    ];

    const evertonScorers = [
      "Dominic Calvert-Lewin",
      "Beto",
      "Jack Grealish",
      "Dwight McNeil",
      "Iliman Ndiaye",
      "Thierno Barry"
    ];

    const villaScorers = [
      "Ollie Watkins",
      "Leon Bailey",
      "Moussa Diaby",
      "John McGinn"
    ];

    function randomScorer(teamName) {
      if (teamName === "Manchester United") return pickRandom(unitedScorers);
      if (teamName === "Everton") return pickRandom(evertonScorers);
      if (teamName === "Aston Villa") return pickRandom(villaScorers);
      return "a player from " + teamName;
    }

    // --- DRUNK HELPERS ---
    function checkDrunkState() {
      if (gameState.drunk >= 5) {
        addLog("You are feeling tipsy, might it be time to eat something?");
      }
      if (gameState.drunk >= 10 && gameState.location !== "Home") {
        blackoutToBed();
      }
    }

    function setDrunk(newValue) {
      gameState.drunk = clamp(newValue, 0, 10);
      checkDrunkState();
    }

    function changeDrunk(delta) {
      if (delta > 0) {
        gameState.drinksCount += 1;
      }
      setDrunk(gameState.drunk + delta);
    }

    // Satiation cap check: any food except Quorn nuggies
    function canEatMore() {
      if (gameState.satiation >= 10) {
        addLog("There is absolutely no way you are still hungry!");
        return false;
      }
      return true;
    }

    // Queue log lines with a delay; optional per-line callback
    function queueLogEvents(lines, delayMs, onComplete, onEach) {
      let i = 0;
      function next() {
        if (i >= lines.length) {
          if (onComplete) onComplete();
          return;
        }
        const line = lines[i];
        if (onEach) onEach(line);
        addLog(line);
        render();
        i++;
        setTimeout(next, delayMs);
      }
      next();
    }

    // --- WORLD / LOCATIONS ---
    const locations = {
      "Stockport Road": {
        ascii: String.raw`

   It's late on Stockport Road. Headlights smear through drizzle; shopfronts glow
   in neon and sodium. You can see:

          [ ISCA ]       [ UNION PUB ]       [ LEVY BAKERY ]
          [ NISPY ]      [ TESCO ]           [ ATM ]

   Somewhere between glory and shame, you must choose your route.
        `,
        description: "You stand on Stockport Road, poised between greatness and questionable decisions. Where to first?",
        actions: [
          { label: "Go to The Union (Pub)", type: "move", target: "The Union" },
          { label: "Go to Nispy (Fried chicken shop)", type: "move", target: "Nispy" },
          { label: "Go to Isca (Wine bar)", type: "move", target: "Isca" },
          { label: "Go to Levy Bakery (Kebabs)", type: "move", target: "Levy Bakery" },
          { label: "Go to Tesco (Supermarket)", type: "move", target: "Tesco" },
          { label: "Go to ATM (Cash machine)", type: "move", target: "ATM" },
          { label: "Go home and end the night", type: "action", id: "end_night" }
        ]
      },

      "The Union": {
        ascii: String.raw`
           ______________________________________
          |   THE UNION                         |
          |-------------------------------------|
          |  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   TV: âš½       |
          |  â–ˆ   â–ˆ  â–ˆ   â–ˆ  â–ˆ   â–ˆ                |
          |  â–ˆ   â–ˆ  â–ˆ   â–ˆ  â–ˆ   â–ˆ   â™ª KARAOKE â™ª |
          |                                     |
          |   [ BAR ]          [ STICKY FLOOR ] |
          |_____________________________________|

   The pub is loud but comforting. Condensation on windows, pints on every table,
   and Rockin Ronnie guarding the karaoke queue like a dragon.
        `,
        description: "Sticky carpet, familiar faces, and the comforting whiff of spilt Guinness. Rockin Ronnie is queueing up karaoke.",
        actions: [
          { label: "Order a pint of Guinness", type: "action", id: "union_guinness" },
          { label: "Sing a song on karaoke", type: "action", id: "union_karaoke" },
          { label: "Dance with Julie", type: "action", id: "union_dance_julie" },
          { label: "Order Salted Peanuts", type: "action", id: "union_salted_peanuts" },
          { label: "Order Dry Roasted Peanuts", type: "action", id: "union_dry_roasted" },
          { label: "Order Bullys Salt & Vinegar Crisps", type: "action", id: "union_bullys_sv" },
          { label: "Order Bullys Ready Salted Crisps", type: "action", id: "union_bullys_rs" },
          { label: "Leave back to Stockport Road", type: "move", target: "Stockport Road" }
        ]
      },

      "Nispy": {
        ascii: String.raw`
                _____________________________
               |   N I S P Y   C H I C K E N |
               |-----------------------------|
               |  [ HOT LAMP ]   [ MENU ]    |
               |   ðŸ— ðŸ— ðŸ—    1. Meal Deal |
               |   ðŸ— ðŸ— ðŸ—    2. Wings     |
               |                             |
               |  COUNTER  | 'SALT?'   ðŸ§‚   |
               |___________|_________________|

   Heat lamps glow amber over trays of fried chicken. The air is thick with oil,
   spice, and half-shouted orders.
        `,
        description: "The warm glow of the heat lamps. The smell of fried everything. A man in front of you is arguing about sauce.",
        actions: [
          { label: "Order a meal", type: "action", id: "nispy_meal" },
          { label: "Ask for extra salt", type: "action", id: "nispy_salt" },
          { label: "Leave back to Stockport Road", type: "move", target: "Stockport Road" }
        ]
      },

      "Isca": {
        ascii: String.raw`
             ___________________________
            |          ISCA            |
            |--------------------------|
            |   ðŸ·   ðŸ·   ðŸ·          |
            |  [BAR]  glasses softly   |
            |         clinking         |
            |                          |
            |  small tables, candles   |
            |  and low murmured chat   |
            |__________________________|

   Natural wine bottles line the wall, each with a label more abstract than last.
   Someone at the bar is saying 'skin contact' a suspicious amount.
        `,
        description: "Soft lighting, clinking glasses, and someone saying the word 'minerality' unironically.",
        actions: [
          { label: "Order a glass of fizz", type: "action", id: "isca_fizz" },
          { label: "Order a glass of red", type: "action", id: "isca_red" },
          { label: "Order a glass of white", type: "action", id: "isca_white" },
          { label: "Order a cheese board", type: "action", id: "isca_cheese" },
          { label: "Leave back to Stockport Road", type: "move", target: "Stockport Road" }
        ]
      },

      "Levy Bakery": {
        ascii: String.raw`
            _________________________________
           |        LEVY BAKERY (SAMOON)     |
           |---------------------------------|
           |  OVEN: ðŸ”¥ðŸ”¥ðŸ”¥      GRILL: â–“â–“â–“  |
           |                                 |
           |   trays of oval Samoon bread    |
           |   stacked behind a glass case   |
           |                                 |
           |  [ COUNTER ]   'Cash only, luv' |
           |_________________________________|

   The warmth hits you as you step in: fresh bread, grilling meat, sesame and spice.
   This is where nights are anchored and redeemed.
        `,
        description: "The counter is lined with glorious Samoon bread. The grill sizzles. This is the point of no return.",
        actions: [
          { label: "Order a mixed Samoon", type: "action", id: "levy_mixed" },
          { label: "Order a Falafel Samoon", type: "action", id: "levy_falafel" },
          { label: "Leave back to Stockport Road", type: "move", target: "Stockport Road" }
        ]
      },

      "Tesco": {
        ascii: String.raw`
               ___________________________
              |          TESCO            |
              |---------------------------|
              |  AISLE 1  |  AISLE 2      |
              |  snacks   |  frozen veg   |
              |  ----->   |  nuggies âž¤    |
              |                           |
              |  self-checkouts: 'Beep'   |
              |___________________________|

   Fluorescent lighting hums overhead. Baskets clatter, scanners beep, and
   everyone is pretending not to read the meal deal options for the fourth time.
        `,
        description: "Fluorescent lighting, aisles of mild chaos, and a queue of people buying exactly three items.",
        actions: [
          { label: "Buy kitchen roll", type: "action", id: "tesco_kitchen_roll" },
          { label: "Buy Quorn chicken nuggies", type: "action", id: "tesco_quorn" },
          { label: "Leave back to Stockport Road", type: "move", target: "Stockport Road" }
        ]
      },

      "ATM": {
        ascii: String.raw`
           street corner, slightly damp
           ______________________
          |  [    BANK ATM    ] |
          |  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  |
          |  |  ENTER PIN   |  |
          |  |              |  |
          |  |   [Â£Â£Â£Â£]     |  |
          |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  |
          |   card slot  â¬›     |
          |____________________|

   The ATM glows against the dark, a shrine to reckless financial decisions.
        `,
        description: "A lonely ATM hums softly, ready to enable more questionable purchases.",
        actions: [
          { label: "Insert card", type: "action", id: "atm_insert_card" },
          { label: "Withdraw money", type: "action", id: "atm_withdraw" },
          { label: "Take cash", type: "action", id: "atm_take_cash" },
          { label: "Retrieve card", type: "action", id: "atm_retrieve_card" },
          { label: "Leave back to Stockport Road", type: "move", target: "Stockport Road" }
        ]
      },

      "Home": {
        ascii: String.raw`
                 your house, some time later

                 ________________________
                |  __________   ____     |
                | |  SOFA   | | TV |     |
                | |_________| |____|     |
                |                       |
                |   coat on chair       |
                |   keys by the door    |
                |      /\_/\\           |
                |     ( o.o )  ~meow    |
                |      > ^ <            |
                |_______________________|

   You finally make it home. Stockport Road is a rumour outside the window now,
   and the night settles into memory.
        `,
        description: "You finally make it home. A small cat eyes you knowingly. The night in Levenshulme fades into a fuzzy memory.",
        actions: [
          { label: "Restart Lev Miserables", type: "action", id: "restart_game" }
        ]
      }
    };

    // --- MATCH SIMULATION WITH TV ---
    function simulateMatch() {
      const derbies = [
        {
          home: "Manchester United",
          away: "Everton",
          name: "The Sherbets Derby"
        },
        {
          home: "Manchester United",
          away: "Aston Villa",
          name: "The Scrumpuss Derby"
        }
      ];

      const derby = derbies[randInt(0, derbies.length - 1)];

      const fhHome = randInt(0, 3);
      const fhAway = randInt(0, 3);
      const firstHalfGoals = [];
      for (let i = 0; i < fhHome; i++) firstHalfGoals.push({ team: "home" });
      for (let i = 0; i < fhAway; i++) firstHalfGoals.push({ team: "away" });
      firstHalfGoals.sort(() => Math.random() - 0.5);

      const shHomeGoals = randInt(0, 3);
      const shAwayGoals = randInt(0, 3);
      const secondHalfGoals = [];
      for (let i = 0; i < shHomeGoals; i++) secondHalfGoals.push({ team: "home" });
      for (let i = 0; i < shAwayGoals; i++) secondHalfGoals.push({ team: "away" });
      secondHalfGoals.sort(() => Math.random() - 0.5);

      let homeTotal = fhHome + shHomeGoals;
      let awayTotal = fhAway + shAwayGoals;
      let wentToET = false;
      let etGoals = [];
      let winner = null;

      const lines = [];

      lines.push(`Potts and The Devil summon you to The Union to watch ${derby.home} vs ${derby.away} (${derby.name}).`);

      firstHalfGoals.forEach((g) => {
        const teamName = g.team === "home" ? derby.home : derby.away;
        const scorer = randomScorer(teamName);
        lines.push(`First half: GOAL for ${teamName}! ${scorer} scores.`);
      });

      lines.push(`Half time: ${derby.home} ${fhHome}â€“${fhAway} ${derby.away}.`);

      secondHalfGoals.forEach((g) => {
        const teamName = g.team === "home" ? derby.home : derby.away;
        const scorer = randomScorer(teamName);
        lines.push(`Second half: GOAL for ${teamName}! ${scorer} finds the net.`);
      });

      if (homeTotal === awayTotal) {
        if (Math.random() < 0.6) {
          wentToET = true;
          const etHome = randInt(0, 2);
          const etAway = randInt(0, 2);
          const beforeETHome = homeTotal;
          const beforeETAway = awayTotal;

          for (let i = 0; i < etHome; i++) etGoals.push({ team: "home" });
          for (let i = 0; i < etAway; i++) etGoals.push({ team: "away" });
          etGoals.sort(() => Math.random() - 0.5);

          homeTotal += etHome;
          awayTotal += etAway;

          lines.push(`After 90 minutes it's still level at ${derby.home} ${beforeETHome}â€“${beforeETAway} ${derby.away}. It goes to extra time.`);

          etGoals.forEach((g) => {
            const teamName = g.team === "home" ? derby.home : derby.away;
            const scorer = randomScorer(teamName);
            lines.push(`Extra time: GOAL for ${teamName}! ${scorer} might have won it.`);
          });

          lines.push(`After extra time: ${derby.home} ${homeTotal}â€“${awayTotal} ${derby.away}.`);
        }
      }

      let homePens = 0;
      let awayPens = 0;

      if (homeTotal === awayTotal) {
        homePens = randInt(4, 7);
        awayPens = randInt(4, 7);
        if (awayPens === homePens) {
          awayPens += (Math.random() < 0.5 ? 1 : -1);
          if (awayPens < 0) awayPens = 0;
        }

        const homeWins = homePens > awayPens;
        if (!wentToET) {
          lines.push(`After 90 minutes it's still level at ${derby.home} ${homeTotal}â€“${awayTotal} ${derby.away}. It goes straight to penalties.`);
        } else {
          lines.push("It's still level after extra time. It goes to penalties.");
        }

        lines.push("Penalty shootout: the bar falls silent as each kick is taken...");

        if (homeWins) {
          lines.push(`${derby.home} win ${homePens}â€“${awayPens} on penalties.`);
          winner = derby.home;
        } else {
          lines.push(`${derby.away} win ${awayPens}â€“${homePens} on penalties.`);
          winner = derby.away;
        }
      } else {
        if (wentToET) {
          lines.push(`Full time after extra time: ${derby.home} ${homeTotal}â€“${awayTotal} ${derby.away}.`);
        } else {
          lines.push(`Full time: ${derby.home} ${homeTotal}â€“${awayTotal} ${derby.away}.`);
        }
        winner = homeTotal > awayTotal ? derby.home : derby.away;
      }

      if (winner === "Everton") {
        lines.push("Everton win! Potts is elated and announces he's off home to roast a chicken.");
      } else if (winner === "Manchester United") {
        lines.push("Manchester United win! The Devil is in his element and buys you a Guinness.");
      } else if (winner === "Aston Villa") {
        lines.push("Aston Villa win! Your wife turns up at The Union and buys you a Guinness.");
      }

      gameState.matchesWatched += 1;

      const footballScreen = document.getElementById("footballScreen");
      footballScreen.style.display = "flex";

      queueLogEvents(
        lines,
        2000,
        () => {
          if (winner === "Manchester United" || winner === "Aston Villa") {
            changeDrunk(2);
          }
          setTimeout(() => {
            footballScreen.style.display = "none";
            footballScreen.innerHTML = "";
          }, 4000);
          render();
        },
        (line) => {
          footballScreen.innerHTML = `
            <div class="live-badge">LIVE</div>
            <div class="football-text">${line}</div>
          `;
        }
      );
    }

    // --- RANDOM EVENTS ---
    function maybeRandomEvent() {
      if (gameState.location === "Home") return;
      const roll = Math.random();
      const current = gameState.location;

      if (roll < 0.05 && current !== "The Union") {
        addLog("You bump into The Devil, who grins and steers you firmly towards The Union.");
        gameState.location = "The Union";
        render();
      } else if (roll < 0.10 && current !== "Levy Bakery") {
        addLog("You run into Potts, who insists you accompany him directly to Levy Bakery.");
        gameState.location = "Levy Bakery";
        render();
      } else if (roll < 0.15) {
        addLog("Your phone buzzes: your wife messages asking you to buy Quorn chicken nuggies.");
        gameState.wifeWantsQuorn = true;
      } else if (roll < 0.20 && current !== "The Union") {
        gameState.location = "The Union";
        render();
        simulateMatch();
        return;
      }
    }

    // --- BLACKOUT LOGIC ---
    function blackoutToBed() {
      gameState.drunk = 10;
      gameState.location = "Home";
      addLog("You reach peak drunkenness and the night dissolves. You black out and wake up in bed.");
      addLog("You have only fragments of the evening, but at least you made it home.");
    }

    // --- KARAOKE FLOW ---
    function startKaraokeSongSelection() {
      if (gameState.location !== "The Union") return;
      gameState.karaokeChoosingSong = true;
      addLog("Rockin Ronnie slides the battered karaoke song binder towards you.");
      render();
    }

    function chooseKaraokeSong(songTitle) {
      gameState.karaokeChoosingSong = false;
      gameState.songsPerformed += 1;

      if (gameState.drunk > 7) {
        addLog(`You pick "${songTitle}". Rockin Ronnie sighs, 'You're far too drunk for this,' but cues it up anyway.`);
      } else {
        addLog(`You pick "${songTitle}". Rockin Ronnie reluctantly puts your song on and you absolutely butcher it.`);
      }

      // Karaoke no longer changes drunk level
      const screen = document.getElementById("karaokeScreen");
      screen.style.display = "flex";
      screen.textContent = `â™ª ${songTitle} â™ª`;

      render();

      setTimeout(() => {
        screen.style.display = "none";
        const crowdLikesIt = Math.random() < 0.5;
        if (crowdLikesIt) {
          addLog("The crowd whoops and cheers. For tonight, you're a star.");
        } else {
          addLog("The patrons boo and jeer. Someone shouts for Rockin Ronnie to cut the mic.");
        }
        render();
      }, 5000);
    }

    // --- TACCY VOM VOM ---
    function doTaccyVomVom() {
      const overlay = document.getElementById("censoredOverlay");
      overlay.style.display = "flex";

      setTimeout(() => {
        overlay.style.display = "none";
        addLog("That's disgusting.");
        gameState.satiation = 0;  // drunk unchanged
        render();
      }, 3000);
    }

    // --- ACTION HANDLERS ---
    function performAction(actionId) {
      switch (actionId) {
        // UNION
        case "union_guinness": {
          const decorations = ["heart", "musical note", "shamrock"];
          const decoration = pickRandom(decorations);
          addLog(`Mary hands you a pint of Guinness decorated with a ${decoration}. It's oddly emotional.`);
          changeDrunk(2);
          break;
        }
        case "union_karaoke":
          if (gameState.drunk < 3) {
            addLog("Rockin Ronnie looks you up and down and says you're far too sober to touch the mic. Come back after a few more drinks.");
          } else {
            startKaraokeSongSelection();
          }
          break;
        case "union_dance_julie":
          addLog("You dance with Julie. It's chaotic but unforgettable.");
          changeDrunk(1);
          break;
        case "union_salted_peanuts":
          if (!canEatMore()) break;
          addLog("You grab a packet of salted peanuts. Salty, crunchy, vaguely stabilising.");
          gameState.foodCount += 1;
          gameState.satiation = clamp(gameState.satiation + 1, 0, 10);
          changeDrunk(-1);
          break;
        case "union_dry_roasted":
          if (!canEatMore()) break;
          addLog("You order dry roasted peanuts. A sophisticated sort of chaos.");
          gameState.foodCount += 1;
          gameState.satiation = clamp(gameState.satiation + 1, 0, 10);
          changeDrunk(-1);
          break;
        case "union_bullys_sv":
          if (!canEatMore()) break;
          addLog("You crack open a bag of Bullys salt & vinegar crisps. Eye-wateringly sharp, gloriously necessary.");
          gameState.foodCount += 1;
          gameState.satiation = clamp(gameState.satiation + 1, 0, 10);
          changeDrunk(-1);
          break;
        case "union_bullys_rs":
          if (!canEatMore()) break;
          addLog("You go for Bullys ready salted crisps. Classic, dependable, exactly what you needed.");
          gameState.foodCount += 1;
          gameState.satiation = clamp(gameState.satiation + 1, 0, 10);
          changeDrunk(-1);
          break;

        // NISPY
        case "nispy_meal":
          if (!gameState.hasCash) {
            addLog("You try to order a meal but realise you have no cash. Nispy is not impressed. Hit the ATM first.");
          } else {
            if (!canEatMore()) break;
            addLog("You order a gloriously beige meal. Future you will have opinions.");
            gameState.foodCount += 1;
            gameState.satiation = clamp(gameState.satiation + 2, 0, 10);
            changeDrunk(-3);
            gameState.hasCash = false;
          }
          break;
        case "nispy_salt":
          addLog("The staff glare and say, 'The food is salty enough already, NO WAY!'");
          break;

        // ISCA
        case "isca_fizz":
          addLog("You sip a glass of fizz and briefly consider moving to Paris.");
          changeDrunk(1);
          break;
        case "isca_red":
          addLog("You savour a glass of red and nod like you understand tannins.");
          changeDrunk(1);
          break;
        case "isca_white":
          addLog("You enjoy a crisp white that 'really opens up on the second sip'. Allegedly.");
          changeDrunk(1);
          break;
        case "isca_cheese":
          if (!canEatMore()) break;
          addLog("You order a cheese board. It briefly silences the table.");
          gameState.foodCount += 1;
          gameState.satiation = clamp(gameState.satiation + 1, 0, 10);
          changeDrunk(-2);
          break;

        // LEVY BAKERY
        case "levy_mixed":
          if (!gameState.hasCash) {
            addLog("You reach for your wallet... empty. The staff kindly suggest you visit the ATM first.");
          } else {
            if (!canEatMore()) break;
            addLog("You buy a mixed Samoon. This is the crescendo of the night.");
            gameState.eatenSamoon = true;
            gameState.foodCount += 1;
            gameState.satiation = clamp(gameState.satiation + 3, 0, 10);
            changeDrunk(-3);
            gameState.hasCash = false;
          }
          break;
        case "levy_falafel":
          if (!gameState.hasCash) {
            addLog("You try to order a Falafel Samoon but realise you have no cash. Levy Bakery waits, but your wallet does not.");
          } else {
            if (!canEatMore()) break;
            addLog("You buy a Falafel Samoon. Glorious, messy, perfect.");
            gameState.eatenSamoon = true;
            gameState.foodCount += 1;
            gameState.satiation = clamp(gameState.satiation + 3, 0, 10);
            changeDrunk(-3);
            gameState.hasCash = false;
          }
          break;

        // TESCO
        case "tesco_kitchen_roll":
          addLog("You buy kitchen roll. Responsible, if not glamorous.");
          break;
        case "tesco_quorn":
          // Quorn nuggies IGNORE satiation-10 guard
          if (gameState.wifeWantsQuorn) {
            addLog("You dutifully buy Quorn chicken nuggies. Your wife will be pleased (or at least less annoyed).");
            gameState.wifeWantsQuorn = false;
          } else {
            addLog("You grab a bag of Quorn chicken nuggies. Future you will thank you (or not).");
          }
          gameState.foodCount += 1;
          gameState.satiation = clamp(gameState.satiation + 1, 0, 10);
          break;

        // ATM
        case "atm_insert_card":
          if (!gameState.hasCard && !gameState.cardInMachine) {
            addLog("You pat your pockets. No card. Perhaps the ATM already claimed it earlier.");
          } else if (gameState.cardInMachine) {
            addLog("Your card is already in the machine.");
          } else {
            gameState.hasCard = false;
            gameState.cardInMachine = true;
            addLog("You insert your card into the ATM.");
          }
          break;
        case "atm_withdraw":
          if (!gameState.cardInMachine) {
            addLog("The ATM beeps impatiently. It would like a card first.");
          } else {
            gameState.pendingCash = true;
            addLog("You request some cash. The machine whirs loudly.");
          }
          break;
        case "atm_take_cash":
          if (!gameState.pendingCash) {
            addLog("There is no cash waiting for you. You stare at the slot hopefully anyway.");
          } else {
            gameState.pendingCash = false;
            gameState.hasCash = true;
            addLog("You take the cash. You are now Samoon-enabled.");
          }
          break;
        case "atm_retrieve_card":
          if (!gameState.cardInMachine) {
            addLog("There is no card to retrieve. Maybe itâ€™s already in your pocket. Maybe it never was.");
          } else {
            gameState.cardInMachine = false;
            gameState.hasCard = true;
            addLog("You retrieve your card and tuck it safely away.");
          }
          break;

        // TACCY VOM VOM
        case "taccy_vom_vom":
          doTaccyVomVom();
          break;

        // END OF NIGHT
        case "end_night":
          endNight();
          render();
          return;

        // RESTART
        case "restart_game":
          window.location.reload();
          return;

        default:
          addLog("You do something indescribable. (Action not implemented.)");
      }

      if (gameState.location !== "Home") {
        maybeRandomEvent();
      }
      render();
    }

    function endNight() {
      gameState.location = "Home";

      addLog("=== END OF NIGHT ===");

      const hasSamoon = gameState.eatenSamoon;
      const hasCardNow = gameState.hasCard && !gameState.cardLost;

      let reasons = [];
      if (!hasSamoon) reasons.push("you never got your Samoon");
      if (!hasCardNow) reasons.push("you lost track of your card");

      if (hasSamoon && hasCardNow) {
        addLog("WIN: You ate Samoon and made it home with your card. A small but powerful victory.");
      } else {
        const joined = reasons.join(" and ");
        addLog("LOSE: Tonight, " + joined + ". Levenshulme will give you another chance, though.");
      }

      addLog(
        "Final stats â€” Drunk: " + gameState.drunk +
        " / Satiation: " + gameState.satiation +
        " / Cash: " + (gameState.hasCash ? "Yes" : "No") +
        " / Bank Card: " + (hasCardNow ? "Safely with you" : "Not with you")
      );

      if (gameState.drunk >= 8) {
        addLog("You are very much at the â€˜singing to the kebabâ€™ stage of the evening.");
      } else if (gameState.drunk <= 2) {
        addLog("A surprisingly sensible night. Are you feeling okay?");
      }

      if (gameState.satiation >= 8) {
        addLog("You are absolutely stuffed. Samoon plus snacks was perhaps ambitious.");
      } else if (gameState.satiation <= 2) {
        addLog("You probably should have eaten more than that.");
      }
    }

    // --- RENDERING ---
    function render() {
      const loc = locations[gameState.location];

      const asciiEl = document.getElementById("asciiArt");
      const descEl = document.getElementById("description");
      const choicesEl = document.getElementById("choices");
      const karaokeChoicesEl = document.getElementById("karaokeChoices");
      const statusLocationEl = document.getElementById("statusLocation");
      const statusCashEl = document.getElementById("statusCash");
      const statusCardEl = document.getElementById("statusCard");
      const statusDrunkEl = document.getElementById("statusDrunk");
      const statusSatiationEl = document.getElementById("statusSatiation");
      const logEl = document.getElementById("log");
      const summaryEl = document.getElementById("sessionSummary");
      const gameOverBanner = document.getElementById("gameOverBanner");

      statusLocationEl.textContent = gameState.location;
      statusCashEl.textContent = gameState.hasCash ? "Yes" : "No";

      if (gameState.hasCard) {
        statusCardEl.textContent = "In your pocket";
      } else if (gameState.cardInMachine) {
        statusCardEl.textContent = "In the ATM";
      } else {
        statusCardEl.textContent = "Lost somewhere";
      }

      statusDrunkEl.textContent = gameState.drunk + " / 10";
      statusSatiationEl.textContent = gameState.satiation + " / 10";

      // GAME OVER banner visibility & text
      if (gameState.location === "Home") {
        if (gameState.wifeWantsQuorn) {
          gameOverBanner.textContent = "GAME OVER YOU FORGOT THE NUGGIES. IT'S D I V O R C E TIME!";
        } else {
          gameOverBanner.textContent = "GAME OVER";
        }
        gameOverBanner.style.display = "block";
      } else {
        gameOverBanner.style.display = "none";
      }

      asciiEl.textContent = loc.ascii;
      descEl.textContent = loc.description;

      // Karaoke song list
      karaokeChoicesEl.innerHTML = "";
      if (gameState.karaokeChoosingSong && gameState.location === "The Union") {
        karaokeChoicesEl.style.display = "flex";
        const title = document.createElement("div");
        title.className = "karaoke-choices-title";
        title.textContent = "Choose your karaoke song:";
        karaokeChoicesEl.appendChild(title);

        karaokeSongs.forEach((song, i) => {
          const btn = document.createElement("button");
          btn.textContent = (i + 1) + ". " + song;
          btn.addEventListener("click", () => chooseKaraokeSong(song));
          karaokeChoicesEl.appendChild(btn);
        });
      } else {
        karaokeChoicesEl.style.display = "none";
      }

      // Choices
      choicesEl.innerHTML = "";
      const actionsToShow = [...loc.actions];

      // Conditionally add Taccy Vom Vom option (global special)
      if (
        gameState.location !== "Home" &&
        gameState.satiation === 10 &&
        gameState.drunk >= 5
      ) {
        actionsToShow.push({
          label: "Taccy Vom Vom",
          type: "action",
          id: "taccy_vom_vom"
        });
      }

      actionsToShow.forEach((action, index) => {
        const btn = document.createElement("button");
        btn.textContent = (index + 1) + ". " + action.label;
        btn.addEventListener("click", () => handleChoice(actionsToShow, index));
        choicesEl.appendChild(btn);
      });

      // Full history, latest at the top; top entry bold
      logEl.innerHTML = "";
      const allEntries = [...gameState.log].reverse();
      allEntries.forEach((entry, idx) => {
        const div = document.createElement("div");
        div.className = "log-entry";
        if (idx === 0) {
          const strong = document.createElement("strong");
          strong.textContent = "â€¢ " + entry;
          div.appendChild(strong);
        } else {
          div.textContent = "â€¢ " + entry;
        }
        logEl.appendChild(div);
      });
      logEl.scrollTop = 0;

      // Session summary
      summaryEl.innerHTML = "";
      const items = [
        `Drinks consumed (including shots, pints, etc): ${gameState.drinksCount}`,
        `Food items eaten: ${gameState.foodCount}`,
        `Matches watched at The Union: ${gameState.matchesWatched}`,
        `Songs performed: ${gameState.songsPerformed}`,
        `Samoon eaten: ${gameState.eatenSamoon ? "Yes" : "No"}`,
        `Wife currently waiting on Quorn nuggies: ${gameState.wifeWantsQuorn ? "Yes" : "No"}`
      ];
      items.forEach(text => {
        const li = document.createElement("li");
        li.textContent = text;
        summaryEl.appendChild(li);
      });
    }

    function handleChoice(actionsListOrIndex, maybeIndex) {
      let actionsList, index;
      if (Array.isArray(actionsListOrIndex)) {
        actionsList = actionsListOrIndex;
        index = maybeIndex;
      } else {
        // keyboard path, will be overridden below in keyboard handler
        return;
      }

      const currentLocationName = gameState.location;
      const action = actionsList[index];
      if (!action) return;

      if (action.type === "move") {
        gameState.karaokeChoosingSong = false;

        if (currentLocationName === "ATM" && gameState.cardInMachine) {
          addLog("You wander off, leaving your card in the ATM. Oops.");
          gameState.cardInMachine = false;
          gameState.hasCard = false;
          gameState.cardLost = true;
        }

        gameState.location = action.target;
        addLog("You head to " + action.target + ".");
        if (gameState.location !== "Home") {
          maybeRandomEvent();
        }
        render();
      } else if (action.type === "action") {
        performAction(action.id);
      }
    }

    function addLog(text) {
      gameState.log.push(text);
    }

    // Theme toggle
    const themeToggleBtn = document.getElementById("themeToggle");
    themeToggleBtn.addEventListener("click", () => {
      const isLight = document.body.classList.toggle("light");
      themeToggleBtn.textContent = isLight ? "Switch to Dark Mode" : "Switch to Light Mode";
    });

    // Keyboard shortcuts 1â€“9
    document.addEventListener("keydown", (event) => {
      if (!/^[1-9]$/.test(event.key)) return;
      const choiceIndex = parseInt(event.key, 10) - 1;

      const loc = locations[gameState.location];
      let actionsToShow = [...loc.actions];
      if (
        gameState.location !== "Home" &&
        gameState.satiation === 10 &&
        gameState.drunk >= 5
      ) {
        actionsToShow.push({
          label: "Taccy Vom Vom",
          type: "action",
          id: "taccy_vom_vom"
        });
      }

      handleChoice(actionsToShow, choiceIndex);
    });

    // Start game
    window.addEventListener("load", () => {
      addLog("You step out onto Stockport Road. The night begins.");
      render();
    });
  </script>
</body>
</html>
